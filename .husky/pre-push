#!/usr/bin/env sh

# 1. Error checking (lint + typecheck)
echo "ğŸ” Checking for errors..."
bun run check:errors || exit 1

# 2. Identifying files that need formatting
echo "ğŸ§ª Checking formatting..."
# We use || true because prettier --list-different returns a non-zero exit code if there are differences
FILES_TO_FORMAT=$(bunx prettier --list-different .) || true

if [ -n "$FILES_TO_FORMAT" ]; then
    echo "âœ¨ Files were found with incorrect formatting. Fixing..."

    # Format only the affected files
    echo "$FILES_TO_FORMAT" | xargs bunx prettier --write

    # Add only these specific files to the Git index
    echo "$FILES_TO_FORMAT" | xargs git add

    # Create the commit with the requested message
    # --no-verify is crucial to avoid triggering hooks in a loop
    git commit -m "refactor: format with prettier" --no-verify

    echo ""
    echo "------------------------------------------------------------"
    echo "âœ… Formatting completed and committed automatically."
    echo "ğŸš€ Push cancelled to include this new commit."
    echo "ğŸ‘‰ Please run 'git push' again to send all commits."
    echo "------------------------------------------------------------"
    echo ""

    # Cancel the current push to force a re-push with the new commit
    exit 1
else
    echo "âœ… Formatting is perfect. Proceeding with push..."
fi
