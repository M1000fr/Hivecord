#!/usr/bin/env sh

# Skip hook in CI environments to avoid conflicts with automated processes (like semantic-release)
if [ "$CI" = "true" ]; then
    exit 0
fi

# 1. Error checking (lint + typecheck)
echo "ğŸ” Checking for errors..."
bun run check:errors || exit 1

# 2. Identifying files that need formatting/lint fixing
echo "ğŸ§ª Checking formatting and linting..."
# Biome check --write will report files that it would change
# We use --no-errors-on-unmatched to avoid failing if no files match
FILES_TO_FIX=$(bunx biome check .) || true

# Check if there are changes to be committed
if ! git diff --exit-code --quiet; then
    echo "âœ¨ Files were found with incorrect formatting or fixable lint errors. Fixing..."

    # Apply fixes
    bunx biome check --write .

    # Add changes to Git index
    git add .

    # Create the commit
    # --no-verify is crucial to avoid triggering hooks in a loop
    git commit -m "refactor: format and lint with biome" --no-verify

    echo ""
    echo "------------------------------------------------------------"
    echo "âœ… Formatting and linting fixed and committed automatically."
    echo "ğŸš€ Push cancelled to include this new commit."
    echo "ğŸ‘‰ Please run 'git push' again to send all commits."
    echo "------------------------------------------------------------"
    echo ""

    # Cancel the current push to force a re-push with the new commit
    exit 1
else
    echo "âœ… Code style and linting are perfect. Proceeding with push..."
fi
