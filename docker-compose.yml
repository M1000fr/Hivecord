name: LeBot Production
services:
    mariadb:
        image: mariadb:latest
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
            MYSQL_DATABASE: ${MYSQL_DATABASE:-lebot_db}
            MYSQL_USER: ${MYSQL_USER:-lebot_user}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD:-lebot_password}
        healthcheck:
            test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
            start_period: 10s
            interval: 10s
            timeout: 5s
            retries: 3
        volumes:
            - mariadb_data:/var/lib/mysql

    redis:
        image: redis:alpine
        restart: always
        volumes:
            - redis_data:/data

    influxdb:
        image: influxdb:2.7-alpine
        restart: always
        environment:
            DOCKER_INFLUXDB_INIT_MODE: setup
            DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USER:-admin}
            DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-adminpassword}
            DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-lebot}
            DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-stats}
            DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-lebottoken123456789}
        healthcheck:
            test: ["CMD", "influx", "ping"]
            start_period: 10s
            interval: 10s
            timeout: 5s
            retries: 3
        volumes:
            - influxdb_data:/var/lib/influxdb2
            - influxdb_config:/etc/influxdb2

    bot:
        build: .
        restart: always
        image: reg.m1000.fr/leserveur/lebot:latest
        depends_on:
            mariadb:
                condition: service_healthy
            redis:
                condition: service_started
            influxdb:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "bun", "src/healthcheck.ts"]
            interval: 30s
            timeout: 10s
            retries: 3
        environment:
            DATABASE_URL: mysql://${MYSQL_USER:-lebot_user}:${MYSQL_PASSWORD:-lebot_password}@mariadb:3306/${MYSQL_DATABASE:-lebot_db}
            REDIS_URL: redis://redis:6379
            INFLUX_URL: http://influxdb:8086
            INFLUX_TOKEN: ${INFLUX_TOKEN:-lebottoken123456789}
            INFLUX_ORG: ${INFLUX_ORG:-lebot}
            INFLUX_BUCKET: ${INFLUX_BUCKET:-stats}
            DISCORD_TOKEN: ${DISCORD_TOKEN}
            DISCORD_GUILD_ID: ${DISCORD_GUILD_ID}
            DISCORD_OWNER_ID: ${DISCORD_OWNER_ID}
            BACKUP_SECRET: ${BACKUP_SECRET}

volumes:
    mariadb_data:
    redis_data:
    influxdb_data:
    influxdb_config:
