generator client {
    provider = "prisma-client"
    output   = "../src/prisma/client"
}

datasource db {
    provider = "mysql"
}

enum ChannelType {
    TEXT
    VOICE
    CATEGORY
}

enum SanctionType {
    WARN
    MUTE
    KICK
    BAN
}

model User {
    id     String    @id
    leftAt DateTime?

    Groups            UserGroup[]
    SanctionsReceived Sanction[]  @relation("UserSanctions")
    SanctionsApplied  Sanction[]  @relation("ModeratorSanctions")
}

model Guild {
    id   String @id
    name String

    Channels       Channel[]
    Roles          Role[]
    Groups         Group[]
    Sanctions      Sanction[]
    Configurations Configuration[]
    CustomEmbeds   CustomEmbed[]
}

model Channel {
    id        String      @id
    guildId   String
    Guild     Guild       @relation(fields: [guildId], references: [id])
    type      ChannelType
    deletedAt DateTime?

    SingleChannelConfigs ChannelConfiguration[]     @relation("SingleChannelConfigs")
    ListChannelConfigs   ChannelListConfiguration[] @relation("ListChannelConfigs")
}

model Role {
    id        String    @id
    guildId   String
    Guild     Guild     @relation(fields: [guildId], references: [id])
    deletedAt DateTime?

    Groups            Group[]
    SingleRoleConfigs RoleConfiguration[]     @relation("SingleRoleConfigs")
    ListRoleConfigs   RoleListConfiguration[] @relation("ListRoleConfigs")
}

model Permission {
    id   Int    @id @default(autoincrement())
    name String

    GroupsPermissions GroupPermission[]
}

model UserGroup {
    id      Int    @id @default(autoincrement())
    userId  String
    groupId Int

    Users  User  @relation(fields: [userId], references: [id])
    Groups Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
}

model GroupPermission {
    id           Int @id @default(autoincrement())
    groupId      Int
    permissionId Int

    Groups      Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
    Permissions Permission @relation(fields: [permissionId], references: [id])
}

model Group {
    id      Int    @id @default(autoincrement())
    guildId String
    Guild   Guild  @relation(fields: [guildId], references: [id])
    name    String

    roleId String
    Role   Role   @relation(fields: [roleId], references: [id])

    UserGroups  UserGroup[]
    Permissions GroupPermission[]
}

model Sanction {
    id          Int          @id @default(autoincrement())
    guildId     String
    Guild       Guild        @relation(fields: [guildId], references: [id])
    userId      String
    moderatorId String
    type        SanctionType
    reason      String
    createdAt   DateTime     @default(now())
    expiresAt   DateTime?
    active      Boolean      @default(true)

    User      User @relation("UserSanctions", fields: [userId], references: [id])
    Moderator User @relation("ModeratorSanctions", fields: [moderatorId], references: [id])
}

model Configuration {
    id      Int    @id @default(autoincrement())
    guildId String
    Guild   Guild  @relation(fields: [guildId], references: [id])
    key     String
    value   String

    @@index([guildId, key])
}

model ChannelConfiguration {
    key       String  @id
    channelId String
    Channel   Channel @relation("SingleChannelConfigs", fields: [channelId], references: [id])
}

model ChannelListConfiguration {
    key       String
    channelId String
    Channel   Channel @relation("ListChannelConfigs", fields: [channelId], references: [id])

    @@id([key, channelId])
}

model RoleConfiguration {
    key    String @id
    roleId String
    Role   Role   @relation("SingleRoleConfigs", fields: [roleId], references: [id])
}

model RoleListConfiguration {
    key    String
    roleId String
    Role   Role   @relation("ListRoleConfigs", fields: [roleId], references: [id])

    @@id([key, roleId])
}

model CustomEmbed {
    guildId   String
    Guild     Guild    @relation(fields: [guildId], references: [id])
    name      String
    data      String   @db.Text // JSON content
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@id([guildId, name])
}

model BotState {
    key       String   @id
    value     String
    updatedAt DateTime @updatedAt
}
