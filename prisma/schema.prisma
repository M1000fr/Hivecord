generator client {
    provider = "prisma-client"
    output   = "../src/prisma/client"
}

datasource db {
    provider = "mysql"
}

enum ChannelType {
    TEXT
    VOICE
    CATEGORY
}

model User {
    id     String    @id
    leftAt DateTime?

    Groups            UserGroup[]
    SanctionsReceived Sanction[]  @relation("UserSanctions")
    SanctionsApplied  Sanction[]  @relation("ModeratorSanctions")

    TempVoiceChannels TempVoiceChannel[]
    TempVoiceAllowed  TempVoiceAllowedUser[]
    TempVoiceBlocked  TempVoiceBlockedUser[]

    InvitedBy      Invitation[] @relation("InvitedBy")
    InvitedMembers Invitation[] @relation("Inviter")

    TicketsCreated Ticket[]

    UserAchievements UserAchievement[]
    UserStats        UserStats[]
}

model Guild {
    id   String @id
    name String

    Invitations       Invitation[]
    Channels          Channel[]
    Roles             Role[]
    Groups            Group[]
    Sanctions         Sanction[]
    Configurations    Configuration[]
    TempVoiceChannels TempVoiceChannel[]

    Achievements     Achievement[]
    UserStats        UserStats[]
    SanctionReasons   SanctionReason[]
    CustomEmbeds      CustomEmbed[]
    Tickets           Ticket[]
}

model Invitation {
    id        Int      @id @default(autoincrement())
    guildId   String
    inviterId String
    invitedId String
    code      String
    active    Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    Inviter User  @relation("Inviter", fields: [inviterId], references: [id])
    Invited User  @relation("InvitedBy", fields: [invitedId], references: [id])
    Guild   Guild @relation(fields: [guildId], references: [id])

    @@index([inviterId])
    @@index([invitedId])
    @@index([guildId])
}

model Channel {
    id        String      @id
    guildId   String
    Guild     Guild       @relation(fields: [guildId], references: [id])
    type      ChannelType
    deletedAt DateTime?

    ChannelConfigurations ChannelConfiguration[]
    Ticket                Ticket?
}

model Role {
    id        String    @id
    guildId   String
    Guild     Guild     @relation(fields: [guildId], references: [id])
    deletedAt DateTime?

    Groups             Group[]
    RoleConfigurations RoleConfiguration[]
}

model Permission {
    id   Int    @id @default(autoincrement())
    name String

    GroupsPermissions GroupPermission[]
}

model UserGroup {
    id      Int    @id @default(autoincrement())
    userId  String
    groupId Int

    Users  User  @relation(fields: [userId], references: [id])
    Groups Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
}

model GroupPermission {
    id           Int @id @default(autoincrement())
    groupId      Int
    permissionId Int

    Groups      Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
    Permissions Permission @relation(fields: [permissionId], references: [id])
}

model Group {
    id      Int    @id @default(autoincrement())
    guildId String
    Guild   Guild  @relation(fields: [guildId], references: [id])
    name    String

    roleId String
    Role   Role   @relation(fields: [roleId], references: [id])

    UserGroups  UserGroup[]
    Permissions GroupPermission[]
}

enum SanctionType {
    WARN
    MUTE
    KICK
    BAN
}

model Sanction {
    id          Int          @id @default(autoincrement())
    guildId     String
    Guild       Guild        @relation(fields: [guildId], references: [id])
    userId      String
    moderatorId String
    type        SanctionType
    reason      String
    createdAt   DateTime     @default(now())
    expiresAt   DateTime?
    active      Boolean      @default(true)

    User      User @relation("UserSanctions", fields: [userId], references: [id])
    Moderator User @relation("ModeratorSanctions", fields: [moderatorId], references: [id])
}

model Configuration {
    id      Int    @id @default(autoincrement())
    guildId String
    Guild   Guild  @relation(fields: [guildId], references: [id])
    key     String
    value   String

    @@index([guildId, key])
}

model ChannelConfiguration {
    key       String
    channelId String
    Channel   Channel @relation(fields: [channelId], references: [id])

    @@id([key, channelId])
}

model RoleConfiguration {
    key    String
    roleId String
    Role   Role   @relation(fields: [roleId], references: [id])

    @@id([key, roleId])
}

model TempVoiceChannel {
    id        String   @id
    guildId   String
    Guild     Guild    @relation(fields: [guildId], references: [id])
    ownerId   String
    createdAt DateTime @default(now())
    isLocked  Boolean  @default(false)

    Owner        User                   @relation(fields: [ownerId], references: [id])
    AllowedUsers TempVoiceAllowedUser[]
    BlockedUsers TempVoiceBlockedUser[]
}

model TempVoiceAllowedUser {
    id          Int    @id @default(autoincrement())
    tempVoiceId String
    userId      String

    TempVoiceChannel TempVoiceChannel @relation(fields: [tempVoiceId], references: [id], onDelete: Cascade)
    User             User             @relation(fields: [userId], references: [id])
}

model TempVoiceBlockedUser {
    id          Int    @id @default(autoincrement())
    tempVoiceId String
    userId      String

    TempVoiceChannel TempVoiceChannel @relation(fields: [tempVoiceId], references: [id], onDelete: Cascade)
    User             User             @relation(fields: [userId], references: [id])
}

model SanctionReason {
    id       Int          @id @default(autoincrement())
    guildId  String
    Guild    Guild        @relation(fields: [guildId], references: [id])
    key      String?
    text     String
    type     SanctionType
    duration String?
    isSystem Boolean      @default(false)

    @@unique([guildId, key])
}

model CustomEmbed {
    guildId   String
    Guild     Guild    @relation(fields: [guildId], references: [id])
    name      String
    data      String   @db.Text // JSON content
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@id([guildId, name])
}

model BotState {
    key       String   @id
    value     String
    updatedAt DateTime @updatedAt
}

model Ticket {
    id        Int       @id @default(autoincrement())
    guildId   String
    Guild     Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
    channelId String    @unique
    Channel   Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
    creatorId String
    Creator   User      @relation(fields: [creatorId], references: [id])

    category  String?
    active    Boolean   @default(true)
    createdAt DateTime  @default(now())
    closedAt  DateTime?

    @@index([guildId])
    @@index([creatorId])
}

enum AchievementCategory {
    GLOBAL
    ROTATED
}

enum AchievementType {
    MESSAGE_COUNT
    VOICE_DURATION
    INVITE_COUNT
    MESSAGE_RATE
}

model Achievement {
    id          String              @id
    guildId     String
    Guild       Guild               @relation(fields: [guildId], references: [id], onDelete: Cascade)
    
    name        String
    description String
    category    AchievementCategory
    
    type        AchievementType
    threshold   Int
    
    isActive    Boolean             @default(true)
    updatedAt   DateTime            @updatedAt
    
    UserAchievements UserAchievement[]

    @@unique([guildId, id])
}

model UserAchievement {
    id            Int         @id @default(autoincrement())
    userId        String
    achievementId String
    guildId       String
    unlockedAt    DateTime    @default(now())

    User        User        @relation(fields: [userId], references: [id])
    Achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

    @@unique([userId, achievementId, guildId])
}

model UserStats {
    userId  String
    guildId String
    
    messageCount   Int @default(0)
    voiceDuration  Int @default(0)
    inviteCount    Int @default(0)
    
    updatedAt DateTime @updatedAt

    User    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    Guild   Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)

    @@id([userId, guildId])
}
