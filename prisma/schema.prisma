generator client {
    provider = "prisma-client"
    output   = "../src/prisma/client"
}

datasource db {
    provider = "mysql"
}

enum ChannelType {
    TEXT
    VOICE
    CATEGORY
}

model User {
    id     String    @id
    leftAt DateTime?

    Groups            UserGroup[]
    SanctionsReceived Sanction[]  @relation("UserSanctions")
    SanctionsApplied  Sanction[]  @relation("ModeratorSanctions")

    TempVoiceChannels TempVoiceChannel[]
    TempVoiceAllowed  TempVoiceAllowedUser[]
    TempVoiceBlocked  TempVoiceBlockedUser[]
}

model Channel {
    id        String      @id
    type      ChannelType
    deletedAt DateTime?

    ChannelConfigurations ChannelConfiguration[]
}

model Role {
    id        String    @id
    deletedAt DateTime?

    Groups             Group[]
    RoleConfigurations RoleConfiguration[]
}

model Permission {
    id   Int    @id @default(autoincrement())
    name String

    GroupsPermissions GroupPermission[]
}

model UserGroup {
    id      Int    @id @default(autoincrement())
    userId  String
    groupId Int

    Users  User  @relation(fields: [userId], references: [id])
    Groups Group @relation(fields: [groupId], references: [id])
}

model GroupPermission {
    id           Int @id @default(autoincrement())
    groupId      Int
    permissionId Int

    Groups      Group      @relation(fields: [groupId], references: [id])
    Permissions Permission @relation(fields: [permissionId], references: [id])
}

model Group {
    id   Int    @id @default(autoincrement())
    name String

    roleId String
    Role   Role   @relation(fields: [roleId], references: [id])

    UserGroups  UserGroup[]
    Permissions GroupPermission[]
}

enum SanctionType {
    WARN
    MUTE
    KICK
    BAN
}

model Sanction {
    id          Int          @id @default(autoincrement())
    userId      String
    moderatorId String
    type        SanctionType
    reason      String
    createdAt   DateTime     @default(now())
    expiresAt   DateTime?
    active      Boolean      @default(true)

    User      User @relation("UserSanctions", fields: [userId], references: [id])
    Moderator User @relation("ModeratorSanctions", fields: [moderatorId], references: [id])
}

model Configuration {
    key   String @id
    value String
}

model ChannelConfiguration {
    key       String
    channelId String
    Channel   Channel @relation(fields: [channelId], references: [id])

    @@id([key, channelId])
}

model RoleConfiguration {
    key    String
    roleId String
    Role   Role   @relation(fields: [roleId], references: [id])

    @@id([key, roleId])
}

model TempVoiceChannel {
    id        String   @id
    ownerId   String
    createdAt DateTime @default(now())
    isLocked  Boolean  @default(false)

    Owner        User                   @relation(fields: [ownerId], references: [id])
    AllowedUsers TempVoiceAllowedUser[]
    BlockedUsers TempVoiceBlockedUser[]
}

model TempVoiceAllowedUser {
    id          Int    @id @default(autoincrement())
    tempVoiceId String
    userId      String

    TempVoiceChannel TempVoiceChannel @relation(fields: [tempVoiceId], references: [id], onDelete: Cascade)
    User             User             @relation(fields: [userId], references: [id])
}

model TempVoiceBlockedUser {
    id          Int    @id @default(autoincrement())
    tempVoiceId String
    userId      String

    TempVoiceChannel TempVoiceChannel @relation(fields: [tempVoiceId], references: [id], onDelete: Cascade)
    User             User             @relation(fields: [userId], references: [id])
}

model SanctionReason {
    id       Int          @id @default(autoincrement())
    key      String?      @unique
    text     String
    type     SanctionType
    duration String?
    isSystem Boolean      @default(false)
}
